# 库管理模块

message(STATUS "========================================")
message(STATUS "Library Manager Running...")
message(STATUS "========================================")

# 1. 预定义库选项
include(${CMAKE_CURRENT_SOURCE_DIR}/option.cmake)

# 2. 设置库输出目录
set(LIBRARY_OUTPUT_DIR "${CMAKE_BINARY_DIR}/apps/${PROJECT_NAME}/lib")
file(MAKE_DIRECTORY ${LIBRARY_OUTPUT_DIR})
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${LIBRARY_OUTPUT_DIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${LIBRARY_OUTPUT_DIR})

# 3. 查找并添加所有库子目录
file(GLOB lib_subdirs 
    LIST_DIRECTORIES true 
    RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} 
    "${CMAKE_CURRENT_SOURCE_DIR}/*"
)
list(REMOVE_ITEM lib_subdirs "CMakeLists.txt")

# 4. 定义库管理变量
set(LIB_LIBRARIES "")
set(LIB_INCLUDE_DIR "")

# 5. 遍历所有库目录
foreach(lib_dir IN LISTS lib_subdirs)
    if(IS_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${lib_dir})
        if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${lib_dir}/CMakeLists.txt)
            # 将目录名转换为大写并移除连字符/空格，用于匹配 USE_ 选项
            string(TOUPPER "${lib_dir}" lib_dir_upper)
            string(REGEX REPLACE "[^A-Z0-9]" "" lib_dir_upper_clean "${lib_dir_upper}")
            
            message(STATUS "Checking library: ${lib_dir} -> USE_${lib_dir_upper_clean}")
            
            # 根据开关决定是否添加库
            if(USE_${lib_dir_upper_clean})
                message(STATUS "✓ Found and enabled library: ${lib_dir}")
                
                # 添加子目录
                add_subdirectory(${lib_dir})
                
                # 获取子库导出的目标名
                if(DEFINED ${lib_dir}_TARGET_NAME)
                    set(lib_target_name ${${lib_dir}_TARGET_NAME})
                    list(APPEND LIB_LIBRARIES ${lib_target_name})
                    
                    # 获取子库的头文件目录
                    if(DEFINED ${lib_dir}_INCLUDE_DIRS)
                        list(APPEND LIB_INCLUDE_DIR ${${lib_dir}_INCLUDE_DIRS})
                    else()
                        list(APPEND LIB_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/${lib_dir})
                    endif()
                else()
                    message(WARNING "Library ${lib_dir} did not set target name")
                endif()
            else()
                message(STATUS "✗ Found but disabled library: ${lib_dir}")
            endif()
        endif()
    endif()
endforeach()

# ========================================
# 6. 生成库配置头文件
# ========================================
function(generate_library_config_header)
    # 确定输出目录
    set(CONFIG_OUTPUT_DIR "${CMAKE_CURRENT_SOURCE_DIR}")

    # 创建输出目录
    # file(MAKE_DIRECTORY ${CONFIG_OUTPUT_DIR})
    
    # 配置头文件名
    set(CONFIG_HEADER_NAME "library_config.h")
    set(CONFIG_HEADER_PATH "${CONFIG_OUTPUT_DIR}/${CONFIG_HEADER_NAME}")
    
    # 使用 file(GENERATE)
    set(CONTENT "/**\n")
    set(CONTENT "${CONTENT} * @file library_config.h\n")
    set(CONTENT "${CONTENT} * @brief Library configuration generated by CMake\n")
    set(CONTENT "${CONTENT} * @note This file is auto-generated. Do not edit manually.\n")
    set(CONTENT "${CONTENT} */\n")
    set(CONTENT "${CONTENT}\n")
    set(CONTENT "${CONTENT}#ifndef __LIBRARY_CONFIG_H__\n")
    set(CONTENT "${CONTENT}#define __LIBRARY_CONFIG_H__\n")
    set(CONTENT "${CONTENT}\n")
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}// Library Configuration Macros\n")
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}\n")
    
    foreach(lib_dir IN LISTS lib_subdirs)
        if(IS_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${lib_dir})
            string(TOUPPER "${lib_dir}" lib_dir_upper)
            string(REGEX REPLACE "[^A-Z0-9]" "" lib_dir_upper_clean "${lib_dir_upper}")
            
            set(option_name "USE_${lib_dir_upper_clean}")
            if(DEFINED ${option_name})
                set(CONTENT "${CONTENT}// ${lib_dir} library\n")
                if(${option_name})
                    set(CONTENT "${CONTENT}#define ${option_name} 1\n")
                    set(CONTENT "${CONTENT}#define LIB_${lib_dir_upper_clean}_ENABLED 1\n")
                else()
                    set(CONTENT "${CONTENT}// #define ${option_name} 0\n")
                    set(CONTENT "${CONTENT}#define LIB_${lib_dir_upper_clean}_ENABLED 0\n")
                endif()
                set(CONTENT "${CONTENT}\n")
            endif()
        endif()
    endforeach()
    
    list(LENGTH LIB_LIBRARIES ENABLED_LIB_COUNT)
    
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}// Convenience Macros\n")
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}\n")
    set(CONTENT "${CONTENT}// Enabled library count\n")
    set(CONTENT "${CONTENT}#define ENABLED_LIBRARY_COUNT ${ENABLED_LIB_COUNT}\n")
    set(CONTENT "${CONTENT}\n")
    set(CONTENT "${CONTENT}// Check if any library is enabled\n")
    set(CONTENT "${CONTENT}#if ENABLED_LIBRARY_COUNT > 0\n")
    set(CONTENT "${CONTENT}    #define ANY_LIBRARY_ENABLED 1\n")
    set(CONTENT "${CONTENT}#else\n")
    set(CONTENT "${CONTENT}    #define ANY_LIBRARY_ENABLED 0\n")
    set(CONTENT "${CONTENT}#endif\n")
    set(CONTENT "${CONTENT}\n")
    
    # set(CONTENT "${CONTENT}// ========================================\n")
    # set(CONTENT "${CONTENT}// Build Information\n")
    # set(CONTENT "${CONTENT}// ========================================\n")
    # set(CONTENT "${CONTENT}\n")
    # set(CONTENT "${CONTENT}// CMake version\n")
    # set(CONTENT "${CONTENT}#define CMAKE_VERSION_MAJOR ${CMAKE_VERSION_MAJOR}\n")
    # set(CONTENT "${CONTENT}#define CMAKE_VERSION_MINOR ${CMAKE_VERSION_MINOR}\n")
    # set(CONTENT "${CONTENT}#define CMAKE_VERSION_PATCH ${CMAKE_VERSION_PATCH}\n")
    # set(CONTENT "${CONTENT}#define CMAKE_VERSION_STRING \"${CMAKE_VERSION}\"\n")
    # set(CONTENT "${CONTENT}\n")
    # set(CONTENT "${CONTENT}// Build type\n")
    # set(CONTENT "${CONTENT}#define CMAKE_BUILD_TYPE_${CMAKE_BUILD_TYPE}\n")
    # set(CONTENT "${CONTENT}\n")
    # set(CONTENT "${CONTENT}// C++ standard\n")
    # set(CONTENT "${CONTENT}#define CMAKE_CXX_STANDARD ${CMAKE_CXX_STANDARD}\n")
    # set(CONTENT "${CONTENT}\n")
    
    # if(DEFINED PROJECT_NAME)
    #     set(CONTENT "${CONTENT}// Project information\n")
    #     set(CONTENT "${CONTENT}#define PROJECT_NAME \"${PROJECT_NAME}\"\n")
    #     set(CONTENT "${CONTENT}\n")
    # endif()
    
    set(CONTENT "${CONTENT}// Library output directory\n")
    set(CONTENT "${CONTENT}#define LIBRARY_OUTPUT_DIR \"${LIBRARY_OUTPUT_DIR}\"\n")
    set(CONTENT "${CONTENT}\n")
    
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}// Some Func\n")
    set(CONTENT "${CONTENT}// ========================================\n")
    set(CONTENT "${CONTENT}\n")
    set(CONTENT "${CONTENT}// For Check Lib Enable Status\n")
    set(CONTENT "${CONTENT}#ifndef PRJ_LIB_ENABLED\n")
    set(CONTENT "${CONTENT}#define PRJ_LIB_ENABLED(name) (defined(LIB_##name##_ENABLED) && LIB_##name##_ENABLED)\n")
    set(CONTENT "${CONTENT}#endif\n")
    set(CONTENT "${CONTENT}\n")
    
    set(CONTENT "${CONTENT}#endif // !__LIBRARY_CONFIG_H__\n")
    
    # 输出内容
    file(GENERATE OUTPUT ${CONFIG_HEADER_PATH} CONTENT "${CONTENT}")
    
    # 将配置头文件目录添加到包含路径
    # list(APPEND LIBRARY_INCLUDE_DIRS ${CONFIG_OUTPUT_DIR})
    
    message(STATUS "Generated library config header: ${CONFIG_HEADER_PATH}")
    
    # 返回目录路径
    # set(CONFIG_OUTPUT_DIR ${CONFIG_OUTPUT_DIR} PARENT_SCOPE)
endfunction()

# 生成配置头文件
generate_library_config_header()

# ========================================
# 7. 追加库的包含目录至父变量
# ========================================

set(LIB_LIBRARIES ${LIB_LIBRARIES} PARENT_SCOPE)
set(LIB_LIBRARY_DIR ${LIBRARY_OUTPUT_DIR} PARENT_SCOPE)
set(LIB_INCLUDE_DIR ${LIB_INCLUDE_DIR} PARENT_SCOPE)

# message(STATUS "========================================")
# message(STATUS "Library Manager Summary:")
# message(STATUS "  Total libraries found: ${lib_subdirs}")
# message(STATUS "  Enabled libraries: ${LIB_LIBRARIES}")
# message(STATUS "  Enabled library count: ${ENABLED_LIB_COUNT}")
# message(STATUS "  Include directories: ${LIB_INCLUDE_DIR}")
# message(STATUS "  Library output directory: ${LIBRARY_OUTPUT_DIR}")
# message(STATUS "  Config header generated: library_config.h")
# message(STATUS "========================================")